-- DROP EVERYTHING only run if need to recreate entire db
DROP TABLE IF EXISTS minstant_messenger.room_members;
DROP TABLE IF EXISTS minstant_messenger.messages;
DROP TABLE IF EXISTS minstant_messenger.rooms;
DROP TABLE IF EXISTS minstant_messenger.users;
DROP SCHEMA IF EXISTS minstant_messenger;

-- CREATE
CREATE SCHEMA IF NOT EXISTS minstant_messenger;
CREATE TABLE IF NOT EXISTS minstant_messenger.users (
    username text,
    password text
);
CREATE TABLE IF NOT EXISTS minstant_messenger.rooms (
    room_id int generated by default as identity,
    admin_user text
);
CREATE TABLE IF NOT EXISTS minstant_messenger.room_members (
    room_id int,
    username text
);
CREATE TABLE IF NOT EXISTS  minstant_messenger.messages (
    message_id int generated by default as identity,
    sending_user text,
    receiving_room_id int,
    message text,
    date_sent timestamptz
);

-- ADD CONSTRAINTS
-- PRIMARY KEYS
ALTER TABLE minstant_messenger.users
ADD PRIMARY KEY
(username);

ALTER TABLE minstant_messenger.rooms
ADD PRIMARY KEY
(room_id);

ALTER TABLE minstant_messenger.room_members
ADD PRIMARY KEY
(username, room_id);

ALTER TABLE minstant_messenger.messages
ADD PRIMARY KEY
(message_id);

-- FOREIGN KEYS
ALTER TABLE minstant_messenger.rooms
ADD CONSTRAINT user_fk
FOREIGN KEY (admin_user)
REFERENCES minstant_messenger.users(username)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE minstant_messenger.room_members
ADD CONSTRAINT user_fk
FOREIGN KEY (username)
REFERENCES minstant_messenger.users(username)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE minstant_messenger.room_members
ADD CONSTRAINT room_fk
FOREIGN KEY (room_id)
REFERENCES minstant_messenger.rooms(room_id)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE minstant_messenger.messages
ADD CONSTRAINT user_fk
FOREIGN KEY (sending_user)
REFERENCES minstant_messenger.users(username)
ON UPDATE CASCADE
ON DELETE CASCADE;

ALTER TABLE minstant_messenger.messages
ADD CONSTRAINT room_fk
FOREIGN KEY (receiving_room_id)
REFERENCES minstant_messenger.rooms(room_id)
ON UPDATE CASCADE
ON DELETE CASCADE;

-- NON NULL CONSTRAINTS
ALTER TABLE minstant_messenger.users
ALTER COLUMN password
SET NOT NULL;

ALTER TABLE minstant_messenger.messages
ALTER COLUMN date_sent
SET NOT NULL;
